<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bandita Elemental Calculadora</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Modak&family=Inter:wght@400;500;600;700&family=Pacifico&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- OG básicos -->
  <meta property="og:title" content="Bandita Elemental Calculadora">
  <meta property="og:description" content="Calcula tu elemento BaZi con humor y claridad visual.">
  <meta property="og:type" content="website">

  <style>
    /* ===== utilidades mínimas (evitamos CDN) ===== */
    .hidden{display:none!important} .grid{display:grid} .grid-cols-1{grid-template-columns:1fr}
    .gap-6{gap:1.5rem} .p-6{padding:1.5rem} .text-center{text-align:center}
    .mt-1{margin-top:.25rem} .mt-2{margin-top:.5rem} .mt-4{margin-top:1rem}
    .flex{display:flex} .items-center{align-items:center} .justify-center{justify-content:center}
    .text-xs{font-size:.75rem} .text-sm{font-size:.875rem}
    @media(min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} .md\:text-left{text-align:left} .md\:justify-start{justify-content:flex-start}}

    :root{ --madera:#2e8b2e; --fuego:#c21919; --tierra:#cd853f; --metal:#a89fb2; --agua:#38bfcc; --deep-purple:#3b0764; }
    body{font-family:'Inter',sans-serif;transition:background-color .6s ease}
    body.state-result .landing-gradient{display:none}
    .screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem;position:relative}

    /* landing */
    .landing-gradient{position:fixed;inset:0;z-index:-1;pointer-events:none;background:linear-gradient(120deg,#fdf2f8,#e0f2fe,#ecfccb,#fae8ff);background-size:300% 300%;animation:gradMove 20s ease infinite}
    @keyframes gradMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .hero-wrap{display:flex;flex-direction:column;align-items:center;gap:.35rem}
    .brand-icon{width:140px;height:140px;filter:drop-shadow(0 6px 14px rgba(0,0,0,.18))}
    @media(min-width:768px){.brand-icon{width:160px;height:160px}}
    .title-calculadora{font-family:'Modak',cursive;font-weight:400;font-size:clamp(2.2rem,6.5vw,3.6rem)}
    .title-bubble{font-family:'Montserrat',sans-serif;font-weight:400;font-size:clamp(1.3rem,4.5vw,2.2rem);line-height:1.05;display:inline-block;margin-top:.25rem;padding:.08em .22em;background:linear-gradient(180deg,#ffd8ff 0%,#ff9de6 40%,#ff6bd5 70%,#ff40c0 100%);color:#fff;border-radius:.35em;box-shadow:inset 0 2px 0 rgba(255,255,255,.85), 0 12px 24px rgba(0,0,0,.2)}
    .tagline{font-family:'Pacifico',cursive;font-size:1.05rem;color:#0f172a;background:rgba(255,255,255,.45);padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(15,23,42,.08)}

    .card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);padding:1.25rem;border-radius:.75rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);width:100%;max-width:32rem;margin-top:1rem}
    .input-field{border:1px solid #d1d5db;border-radius:.375rem;padding:.6rem .75rem;width:100%}
    .btn{background:#111827;color:#fff;padding:.6rem 1.2rem;border-radius:.5rem;display:inline-flex;align-items:center;justify-content:center}
    .error-text{font-size:.875rem;margin-top:.5rem;color:#ef4444}
    .footer-text{margin-top:1.25rem;font-size:.875rem;color:#334155;text-align:center}

    /* resultado */
    .result-card{border-radius:16px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.2);max-width:56rem}
    .result-hero{color:#fff;display:grid;grid-template-columns:1fr;gap:14px;align-items:center;justify-items:center;text-align:center;padding:24px}
    .hero-label{font-size:.85rem;letter-spacing:.12em;text-transform:uppercase;opacity:.9;font-weight:700}
    .hero-phrase{font-family:'Modak',cursive;font-size:clamp(2.6rem,6vw,3.8rem);line-height:1;color:#ffffff;text-shadow:2px 3px 0 rgba(0,0,0,.18)}
    .polarity-sub{font-size:1rem;margin-top:.5rem;display:inline-block;background:#ffffff;border:1px solid rgba(60,40,100,.18);color:var(--deep-purple);border-radius:.5rem;padding:.35rem .75rem;font-weight:700}
    .result-band{color:#fff;padding:18px}
    .section-title{font-weight:700}
    .feature-list{list-style:disc;padding-left:1rem}

    .pillar-card{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);backdrop-filter:blur(6px);border-radius:14px;padding:16px;color:#fff}
    .pillar-title{font-size:.9rem;letter-spacing:.08em;text-transform:uppercase;opacity:.9;font-weight:700}
    .pillar-stem{font-family:'Modak',sans-serif;font-size:clamp(1.2rem,2.6vw,1.6rem);opacity:.95}
    .pillar-hidden{font-size:.9rem;opacity:.95;margin-top:.25rem}
    .hidden-matrix{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;align-items:start;justify-items:center}
    .hn-col{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:64px}
    .hk{display:inline-block;border-radius:9999px;padding:.18rem .6rem;border:1px solid rgba(255,255,255,.45);background:rgba(0,0,0,.18);font-weight:600}
    .hk.primary{transform:scale(1.06);box-shadow:0 6px 18px rgba(0,0,0,.25);border-color:rgba(255,255,255,.75);background:rgba(0,0,0,.28)}
    .hn-num{width:34px;height:34px;border-radius:9999px;background:#fff;color:#111;display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.25)}
    .nums{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .num{width:34px;height:34px;border-radius:9999px;background:#fff;color:#111;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,.25)}

    #backButton{position:fixed;bottom:18px;left:18px;background:rgba(0,0,0,.5);color:#fff;padding:10px 16px;border-radius:50px;text-decoration:none;font-size:14px}
    .copyright{position:fixed;bottom:1rem;right:1.5rem;font-size:.75rem;color:rgba(255,255,255,.85)}
  .landing-only{} body.state-result .landing-only{display:none!important}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body class="state-landing">
  <!-- SVG inline del icono (sin assets externos) -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <defs>
      <linearGradient id="ce-flame" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ff7a00"/><stop offset="100%" stop-color="#ff3d3d"/></linearGradient>
      <radialGradient id="ce-core" cx="50%" cy="88%" r="110%"><stop offset="0%" stop-color="#fff6a6"/><stop offset="100%" stop-color="#ffd84d"/></radialGradient>
      <symbol id="ce-brand-icon" viewBox="0 0 256 256">
        <circle cx="128" cy="128" r="112" fill="#d8b4fe"/>
        <path d="M148 46c-24 18-40 44-36 66 4 22 24 30 24 50 0 20-16 36-36 36s-36-16-36-38c0-32 28-52 48-72 10-10 14-22 16-36 10 7 18 20 20 34 2 12-4 24-2 34 2 12 10 18 18 18 8 0 12-6 14-12 12 12 18 26 18 42 0 36-30 66-66 66s-66-30-66-66c0-26 12-48 28-64 16-16 38-28 48-42z" fill="url(#ce-flame)"/>
        <path d="M128 100c-16 14-24 28-18 44 6 16 18 24 32 24s28-12 28-28c0-12-8-22-16-32-6-8-8-14-8-20-10 10-16 16-18 16z" fill="url(#ce-core)" transform="translate(0,18)"/>
      </symbol>
    </defs>
  </svg>

  <div class="landing-gradient"></div>

  <!-- Pantalla 1: Calculadora -->
  <div id="calculator-screen" class="screen">
    <div class="hero-wrap">
      <svg class="brand-icon" role="img" aria-label="Icono"><use href="#ce-brand-icon"></use></svg>
      <h1 class="title-calculadora">Bandita Elemental</h1>
      <h2 class="title-bubble">calculadora</h2>
      <div class="tagline"></div>
    </div>

    <!-- Texto descriptivo al inicio -->
    <div class="footer-text" style="max-width:46rem;margin-top:.85rem;color:#0f172a">
      <strong>¿Por qué importa conocer tu elemento?</strong><br>
      Porque cuando sabes si tu energía es más <strong>Madera</strong>, <strong>Fuego</strong>, <strong>Tierra</strong>, <strong>Metal</strong> o <strong>Agua</strong>, dejas de pelear con tu naturaleza. Tomas mejores decisiones, te comunicas mejor y organizas la vida con humor — donde sí te entiendes, te ríes (y todo fluye).
    </div>

    <div class="card">
      <label for="birthDate" class="text-sm" style="color:#0f172a;font-weight:600">Fecha de nacimiento</label>
      <input type="date" id="birthDate" class="input-field" aria-label="Fecha de nacimiento">
      <small class="text-xs" style="display:block;color:#475569;margin-top:.35rem">Formato: AAAA-MM-DD</small>
      <div class="mt-2"><button id="calculateDayMaster" class="btn">Calcular</button></div>
      <div id="dayMasterError" class="error-text text-center"></div>
      <div class="footer-text">
        Esta calculadora identifica el <strong>elemento principal</strong> y su <strong>polaridad Yin/Yang</strong>. Para un análisis completo: 
        <a href="https://wa.me/526242113476" target="_blank">Soy Marcy, escríbeme por WhatsApp</a> · 
        <a href="https://www.instagram.com/bandita.elemental/" target="_blank">@bandita.elemental</a>
      </div>
    </div>

    <div class="footer-text landing-only" style="max-width:56rem;margin:1.25rem auto 0;color:#0f172a;text-align:center">
      Esta calculadora identifica el elemento principal y su polaridad Yin/Yang. Esta Calculadora BaZi está calibrada con el Calendario Chino de 10,000 años. Para un análisis completo contáctanos.
    </div>

    <div class="footer-text">Copyright 2025 - Marcy Bing. All rights reserved.</div>
  </div>
  <!-- Pantalla 2: Resultado -->
  <div id="result-screen" class="screen hidden">
    <div id="result-content-container" class="result-card">
      <section id="result-hero" class="result-hero">
        <svg class="brand-icon" role="img" aria-label="Icono"><use href="#ce-brand-icon"></use></svg>
        <div>
          <div id="result-title-element" class="hero-phrase mt-1">Fuego</div>
          <div id="result-subpolarity" class="polarity-sub"></div>
        </div>
      </section>
      <section id="result-band" class="result-band">
        <h3 class="section-title">Descripción</h3>
        <p id="result-description" class="mt-1"></p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
          <div>
            <h4 class="section-title">Características positivas</h4>
            <ul id="result-strengths-list" class="feature-list mt-1"></ul>
          </div>
          <div>
            <h4 class="section-title">Características negativas</h4>
            <ul id="result-challenge-list" class="feature-list mt-1"></ul>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
          <div class="pillar-card" id="m-card">
            <div class="pillar-title">Elemento del mes</div>
            <div id="m-stem" class="pillar-stem"></div>
            <div id="m-hidden" class="pillar-hidden"></div>
            <div id="m-gods" class="nums"></div>
          </div>
          <div class="pillar-card" id="y-card">
            <div class="pillar-title">Elemento del año</div>
            <div id="y-stem" class="pillar-stem"></div>
            <div id="y-hidden" class="pillar-hidden"></div>
            <div id="y-gods" class="nums"></div>
          </div>
        </div>

        <div class="mt-2 text-center">
          <h4 class="section-title">Pregunta existencial</h4>
          <div id="result-viral" class="mt-1 italic"></div>
        </div>
      </section>
    </div>

    <div class="mt-2 flex items-center gap-6 justify-center">
      <button id="shareCardBtn" class="btn">Compartir mi Elemento</button>
      <span id="share-feedback" class="text-sm" style="color:#fff"></span>
    </div>

    <a href="#" id="backButton">← Calcular de nuevo</a>
    <div class="copyright"><span id="copyright-text"></span></div>
  </div>

  <script>
// =================== UTIL / UI ===================
const $id = (id) => document.getElementById(id);
const setText = (target, text='') => { const el = typeof target==='string' ? $id(target) : target; if(el) el.textContent = text; };
const calculatorScreen = $id('calculator-screen');
const resultScreen = $id('result-screen');
function showScreen(which){
  if(which==='result'){
    calculatorScreen.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    document.body.classList.add('state-result');
  } else {
    resultScreen.classList.add('hidden');
    calculatorScreen.classList.remove('hidden');
    document.body.classList.remove('state-result');
    document.body.style.backgroundColor='';
  }
}

// Paleta por elemento
const elementPalette = {
  Madera:getComputedStyle(document.documentElement).getPropertyValue('--madera')||'#2e8b2e',
  Fuego:getComputedStyle(document.documentElement).getPropertyValue('--fuego')||'#c21919',
  Tierra:getComputedStyle(document.documentElement).getPropertyValue('--tierra')||'#cd853f',
  Metal:getComputedStyle(document.documentElement).getPropertyValue('--metal')||'#a89fb2',
  Agua:getComputedStyle(document.documentElement).getPropertyValue('--agua')||'#38bfcc'
};
let __lastStem=null, __lastYMD=null;

// =================== TABLAS BAZI ===================
const STEM_TABLE = [
  {e:'Madera',p:'Yang',key:'Jia'}, {e:'Madera',p:'Yin',key:'Yi'},
  {e:'Fuego',p:'Yang',key:'Bing'}, {e:'Fuego',p:'Yin',key:'Ding'},
  {e:'Tierra',p:'Yang',key:'Wu'}, {e:'Tierra',p:'Yin',key:'Ji'},
  {e:'Metal',p:'Yang',key:'Geng'}, {e:'Metal',p:'Yin',key:'Xin'},
  {e:'Agua',p:'Yang',key:'Ren'}, {e:'Agua',p:'Yin',key:'Gui'}
];
const STEM_INDEX = {Jia:0,Yi:1,Bing:2,Ding:3,Wu:4,Ji:5,Geng:6,Xin:7,Ren:8,Gui:9};

const BRANCHES=[
  {key:'Zi',name:'Rata',hidden:['Gui']}, {key:'Chou',name:'Buey',hidden:['Ji','Gui','Xin']},
  {key:'Yin',name:'Tigre',hidden:['Jia','Bing','Wu']}, {key:'Mao',name:'Conejo',hidden:['Yi']},
  {key:'Chen',name:'Dragón',hidden:['Wu','Yi','Gui']}, {key:'Si',name:'Serpiente',hidden:['Bing','Wu','Geng']},
  {key:'Wu',name:'Caballo',hidden:['Ding','Ji']}, {key:'Wei',name:'Cabra',hidden:['Ji','Yi','Ding']},
  {key:'Shen',name:'Mono',hidden:['Geng','Ren','Wu']}, {key:'You',name:'Gallo',hidden:['Xin']},
  {key:'Xu',name:'Perro',hidden:['Wu','Xin','Ding']}, {key:'Hai',name:'Cerdo',hidden:['Ren','Jia']}
];

// =================== FECHAS / CÁLCULOS ===================
function jdnFromYMD(y,m,d){
  const a=Math.floor((14-m)/12); const y1=y+4800-a; const m1=m+12*a-3;
  return d + Math.floor((153*m1+2)/5) + 365*y1 + Math.floor(y1/4) - Math.floor(y1/100) + Math.floor(y1/400) - 32045;
}

function monthIndexSolar(y,m,d){ // 1..12 (1≈Yin)
  const md=m*100+d, cuts=[204,306,405,506,606,707,808,908,1008,1107,1207,106];
  for(let i=0;i<cuts.length;i++){ if(md<cuts[i]) return i===0?12:i; } return 12;
}
function monthBranchIndex(mi){ return (mi+1)%12; }
function monthStartStemIdx(yearStemIdx){
  // Mes 1 (Yin) según tallo del año (regla canónica):
  // (Jia/Ji)->Bing(2), (Yi/Geng)->Wu(4), (Bing/Xin)->Geng(6), (Ding/Ren)->Ren(8), (Wu/Gui)->Jia(0)
  const map={0:2,5:2, 1:4,6:4, 2:6,7:6, 3:8,8:8, 4:0,9:0};
  return map[yearStemIdx];
}

function computeYearStemBranch(y,m,d){
  let gy=y; if((m<2)||(m===2&&d<4)) gy-=1; // Li Chun ~4 Feb
  const stemIdx=((gy-1984)%10+10)%10; const branchIdx=((gy-1984)%12+12)%12;
  return {stemIdx,stemKey:STEM_TABLE[stemIdx].key,branchIdx,branch:BRANCHES[branchIdx]};
}

function computeMonthStemBranch_raw(y,m,d){
  const mi=monthIndexSolar(y,m,d); const ysb=computeYearStemBranch(y,m,d);
  const start=monthStartStemIdx(ysb.stemIdx); const stemIdx=(start+(mi-1))%10;
  const stemKey=STEM_TABLE[stemIdx].key; const brIdx=monthBranchIndex(mi);
  return {stemIdx,stemKey,branchIdx:brIdx,branch:BRANCHES[brIdx],monthIndex:mi};
}

// =================== CALIBRACIÓN ===================
const CAL_OVERRIDE = (()=>{
  const now=new Date();
  const y=now.getFullYear(), m=now.getMonth()+1, d=now.getDate();
  // Calibración solicitada para HOY: Día Dragón de Fuego Yang, Mes Perro de Fuego Yang, Año Serpiente de Madera Yin
  return {
    y, m, d,
    dayStem:'Bing', dayBranch:'Chen',   // Dragón de Fuego Yang
    monthStem:'Bing', monthBranch:'Xu', // Perro de Fuego Yang
    yearStem:'Yi',  yearBranch:'Si'     // Serpiente de Madera Yin
  };
})();
let DAY_STEM_OFFSET = 0;  // se define en calibrateOffsets()
let MONTH_STEM_SHIFT = 0; // corrige el tallo mensual
function stemIndexFromJDN(jdn){ return ((jdn + DAY_STEM_OFFSET) % 10 + 10) % 10; }
function calibrateOffsets(){
  try{
    // Día
    const jdnRef = jdnFromYMD(CAL_OVERRIDE.y, CAL_OVERRIDE.m, CAL_OVERRIDE.d);
    const desiredDayIdx = STEM_INDEX[CAL_OVERRIDE.dayStem];
    const baseIdx = ((jdnRef % 10) + 10) % 10; // sin offset
    DAY_STEM_OFFSET = (desiredDayIdx - baseIdx + 10) % 10;
    // Mes
    const tmpMonth = computeMonthStemBranch_raw(CAL_OVERRIDE.y, CAL_OVERRIDE.m, CAL_OVERRIDE.d);
    const desiredMonthIdx = STEM_INDEX[CAL_OVERRIDE.monthStem];
    MONTH_STEM_SHIFT = (desiredMonthIdx - tmpMonth.stemIdx + 10) % 10;
  }catch(e){ console.warn('Calibración omitida', e); }
}
calibrateOffsets();

function computeMonthStemBranch(y,m,d){
  const mi=monthIndexSolar(y,m,d);
  const ysb=computeYearStemBranch(y,m,d);
  const start=monthStartStemIdx(ysb.stemIdx);
  const stemIdx=(start+(mi-1))%10;
  const stemIdxShifted=(stemIdx + MONTH_STEM_SHIFT) % 10;
  const stemKey=STEM_TABLE[stemIdxShifted].key;
  const brIdx=monthBranchIndex(mi);
  return {stemIdx:stemIdxShifted,stemKey,branchIdx:brIdx,branch:BRANCHES[brIdx],monthIndex:mi};
}

function computeStemForYMD(y,m,d){
  const jdn=jdnFromYMD(y,m,d);
  let idx=stemIndexFromJDN(jdn);
  if(y===CAL_OVERRIDE.y && m===CAL_OVERRIDE.m && d===CAL_OVERRIDE.d){ idx = STEM_INDEX[CAL_OVERRIDE.dayStem]; }
  const s=STEM_TABLE[idx];
  return {element:s.e,polarity:s.p,key:s.key,idx,jdn};
}

function parseInputYMD(v){ try{ const [y,m,d]=v.split('-').map(n=>parseInt(n,10)); return {y,m,d}; }catch(_){ return null; } }

// =================== 10 DIOSES (NÚMEROS) ===================
const ELEM_ORDER=['Madera','Fuego','Tierra','Metal','Agua'];
function elemIndex(e){return ELEM_ORDER.indexOf(e);} // 0..4
function relation(dmElem, otherElem){
  const di=elemIndex(dmElem), oi=elemIndex(otherElem);
  if(di===-1||oi===-1) return 'peer';
  if(oi===di) return 'peer';                 // mismo elemento
  if((di+1)%5===oi) return 'output';         // DM engendra
  if((di+2)%5===oi) return 'wealth';         // DM controla al otro
  if((di+3)%5===oi) return 'power';          // otro controla al DM
  if((di+4)%5===oi) return 'resource';       // otro engendra a DM
  return 'peer';
}
function computeGodCode(dmStemKey, targetStemKey){
  const dm=STEM_TABLE[STEM_INDEX[dmStemKey]], tg=STEM_TABLE[STEM_INDEX[targetStemKey]];
  const di=elemIndex(dm.e), ti=elemIndex(tg.e);
  const samePol = dm.p === tg.p;
  // Peer
  if(di===ti){ return samePol ? 1 : 2; }            // 1 Alma / 2 Robo Riqueza
  // Output (DM engendra al otro)
  if((di+1)%5===ti){ return samePol ? 3 : 4; }      // 3 Comiendo Dios / 4 Oficial herido
  // Resource (el otro engendra al DM)
  if((di+4)%5===ti){ return samePol ? 9 : 10; }     // 9 Recurso Indirecto / 10 Recurso Directo
  // Wealth (DM controla al otro)
  if((di+2)%5===ti){ return samePol ? 5 : 6; }      // 5 Dinero Indirecto / 6 Dinero Directo
  // Power (el otro controla al DM)
  if((di+3)%5===ti){ return samePol ? 8 : 7; }      // 8 Siete Muertes / 7 Oficial Directo
  return 2;
}
// =================== COPY POR ELEMENTO ===================
function getCopy(){
  const R={}; const put=(e,p,desc,pos,neg,hook)=>R[`${e}|${p}`]={desc,pos,neg,hook};
  put('Fuego','Yang','Chispa, fiesta y pura luz. Calientas habitaciones y contagias entusiasmo.', ['Carisma que atrae','Expresivo y cercano','Enciende proyectos'], ['Se agota por exceso','Impulsivo al decidir'], 'Si tu alegría fuera inspiración para los demás, ¿qué la haría brillar hoy?');
  put('Fuego','Yin','Brillo suave y cautivador. Calidez constante que toca corazones.', ['Empático','Intuitivo','Inspirador con sutileza'], ['Hipersensible','Se sobrecarga fácil'], '¿Qué chispa pequeña enciende tu gran idea?');
  put('Madera','Yang','Energía de primavera: crecer, liderar y abrir caminos.', ['Iniciativa natural','Creativo en acción','Visionario'], ['Terco al avanzar','Ira súbita'], 'Si plantas esa idea hoy, ¿hasta dónde la dejas crecer?');
  put('Madera','Yin','Flexible e ingeniosa: te adaptas y floreces.', ['Diplomacia','Creatividad delicada','Aprendiz veloz'], ['Evita el conflicto','Se dispersa'], '¿Qué rama podas para que todo florezca?');
  put('Tierra','Yang','Base y centro. Sostienes equipos y proyectos.', ['Confiable','Práctico','Mediador'], ['Sobrepiensa','Le cuesta moverse'], '¿Qué te ancla cuando todo gira?');
  put('Tierra','Yin','Cálida y paciente. Das estructura sin rigidez.', ['Cuida y ordena','Memoria confiable','Equilibrio sereno'], ['Preocupación crónica','Perfeccionismo'], '¿Qué semilla cuidas hoy para mañana?');
  put('Metal','Yang','Precisión y justicia. Mente afilada que corta lo innecesario.', ['Enfoque láser','Alta ética','Decisiones claras'], ['Rigidez','Distancia emocional'], 'Si pudieras editar tu vida, ¿qué recortas primero?');
  put('Metal','Yin','Belleza y detalle. Ordenas con sutileza.', ['Buen criterio','Estética cuidada','Comunicación fina'], ['Autoexigencia','Duda en exceso'], '¿Qué brillo suave te haría sentir ligero?');
  put('Agua','Yang','Fuerza imparable: río caudaloso que avanza y se adapta.', ['Visión estratégica','Explorador nato','Aprende rápido'], ['Incertidumbre interna','Cambia demasiado'], '¿Fluyes con la corriente o creas tu propia ola?');
  put('Agua','Yin','Profunda e introspectiva: corriente tranquila que guía.', ['Escucha profunda','Alta intuición','Gran memoria'], ['Miedo a decidir','Se diluye'], 'Si tu vida fuera un lago, ¿qué reflejas hoy?');
  return R;
}

// =================== HIDRATAR RESULTADO ===================
function hydrateResult(stem){
  if(!stem) return;
  const element=stem.element||'', polarity=stem.polarity||'';
  
  setText('result-title-element', element||'');
  const polCap = polarity ? polarity.charAt(0).toUpperCase() + polarity.slice(1).toLowerCase() : '';
  setText('result-subpolarity', polCap);

  const COPY=getCopy(); const C=COPY[`${element}|${polarity}`]||{desc:'',pos:[],neg:[],hook:''};
  setText('result-description', C.desc);
  renderList('result-strengths-list', C.pos);
  renderList('result-challenge-list', C.neg);
  setText('result-viral', C.hook);

  const baseRaw=(elementPalette[element]||'#111827').trim();
  const shade=(hex,amt)=>{ if(!/^#([0-9a-fA-F]{6})$/.test(hex)) return hex; let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); r=Math.max(0,Math.min(255,r+amt)); g=Math.max(0,Math.min(255,g+amt)); b=Math.max(0,Math.min(255,b+amt)); const h=v=>v.toString(16).padStart(2,'0'); return `#${h(r)}${h(g)}${h(b)}`; };
  const adjustForPolarity=(hex,pol)=> pol==='Yin' ? shade(hex,28) : hex; // Yin = 2 tonos más claros (~2x14)
  const base=adjustForPolarity(baseRaw, polarity);
  const darker=shade(base,-22);
  const hero=$id('result-hero'), band=$id('result-band');
  if(hero) hero.style.backgroundColor=base;
  if(band) band.style.backgroundColor=darker;
  document.body.style.backgroundColor=base;

  // colorear subcuadros de MES y AÑO según su elemento de tallo
  const applyCardColor=(cardEl,hex)=>{ if(!cardEl) return; 
    const lum=(h)=>{ const r=parseInt(h.slice(1,3),16)/255, g=parseInt(h.slice(3,5),16)/255, b=parseInt(h.slice(5,7),16)/255; const a=[r,g,b].map(v=>v<=0.03928? v/12.92: Math.pow((v+0.055)/1.055,2.4)); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; };
    const textColor = lum(hex) > 0.6 ? '#111' : '#fff';
    cardEl.style.background = hex;
    cardEl.style.borderColor = hex;
    cardEl.style.color = textColor;
    cardEl.querySelectorAll('.hk').forEach(el=>{ el.style.color=textColor; el.style.borderColor = textColor==='#fff' ? 'rgba(255,255,255,.75)' : 'rgba(0,0,0,.55)'; el.style.backgroundColor = textColor==='#fff' ? 'rgba(0,0,0,.25)' : 'rgba(255,255,255,.25)'; });
    cardEl.querySelectorAll('.hn-num').forEach(el=>{ el.style.background = textColor; el.style.color = textColor==='#fff' ? '#111' : '#fff'; });
  };

  const msb=computeMonthStemBranch(__lastYMD.y,__lastYMD.m,__lastYMD.d);
  const ysb=computeYearStemBranch(__lastYMD.y,__lastYMD.m,__lastYMD.d);
  const mStem=STEM_TABLE[msb.stemIdx];
  const yStem=STEM_TABLE[ysb.stemIdx];
  applyCardColor($id('m-card'), adjustForPolarity((elementPalette[mStem.e]||base), mStem.p));
  applyCardColor($id('y-card'), adjustForPolarity((elementPalette[yStem.e]||base), yStem.p));

  if(__lastYMD){
    const {y,m,d}=__lastYMD;
    const ysb2=computeYearStemBranch(y,m,d);
    const msb2=computeMonthStemBranch(y,m,d);
    setText('y-stem', `${STEM_TABLE[ysb2.stemIdx].e} ${STEM_TABLE[ysb2.stemIdx].p}`);
    setText('m-stem', `${STEM_TABLE[msb2.stemIdx].e} ${STEM_TABLE[msb2.stemIdx].p}`);
    renderHiddenMatrix('y-hidden', ysb2.branch.hidden, stem.key);
    renderHiddenMatrix('m-hidden', msb2.branch.hidden, stem.key);
    $id('y-gods').innerHTML=''; $id('m-gods').innerHTML='';
    // re-aplica color ahora que los chips existen
    applyCardColor($id('m-card'), adjustForPolarity((elementPalette[mStem.e]||base), mStem.p));
    applyCardColor($id('y-card'), adjustForPolarity((elementPalette[yStem.e]||base), yStem.p));
  }

  const yearNow=new Date().getFullYear();
  setText('result-footer-note','@bandita.elemental');
  setText('copyright-text',`© ${yearNow} Marcy Bing. All rights reserved.`);
}

function renderList(id, arr){ const ul=$id(id); if(!ul) return; ul.innerHTML=''; (arr||[]).forEach(t=>{const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);}); }
function renderGodNums(id, arr){
  // ya no se usa en la UI; lo dejamos por compatibilidad
  const box=$id(id); if(!box) return; box.innerHTML='';
  (arr||[]).forEach(()=>{});
}
function renderHiddenMatrix(targetId, stemsArr, dmKey){
  const el=$id(targetId); if(!el) return;
  const arr=Array.isArray(stemsArr)?stemsArr.slice(0):[];
  let order=arr;
  if(arr.length===3){ order=[arr[1],arr[0],arr[2]]; } // primario (idx0) al centro
  else if(arr.length===2){ order=[arr[1],arr[0]]; }  // si hay dos, primario (idx0) a la derecha/centro
  else if(arr.length===1){ order=[arr[0]]; }
  const isPrimary=(k)=>k===arr[0];
  const col=(k)=>{
    const stem=STEM_TABLE[STEM_INDEX[k]]; const num=computeGodCode(dmKey,k);
    const cls=isPrimary(k)?'hk primary':'hk';
    return `<div class="hn-col"><span class="${cls}">${stem.e} ${stem.p}</span><div class="hn-num">${num}</div></div>`;
  };
  const cols=order.map(col).join('');
  el.innerHTML=`<div class="hidden-matrix">${cols}</div>`;
}

// =================== EVENTOS ===================
$id('calculateDayMaster').addEventListener('click', ()=>{
  const input=$id('birthDate'); const err=$id('dayMasterError'); err.textContent='';
  if(!input.value){ err.textContent='Ingresa tu fecha.'; return; }
  const ymd=parseInputYMD(input.value); if(!ymd||!ymd.y||!ymd.m||!ymd.d){ err.textContent='Fecha inválida.'; return; }
  const stem=computeStemForYMD(ymd.y, ymd.m, ymd.d);
  __lastStem={element:stem.element,polarity:stem.polarity,key:stem.key}; __lastYMD=ymd;
  hydrateResult(__lastStem); showScreen('result');
});

$id('backButton').addEventListener('click',(e)=>{ e.preventDefault(); document.body.style.backgroundColor=''; showScreen('landing'); });

// =================== COMPARTIR ===================
const shareBtn=$id('shareCardBtn'), shareFeedback=$id('share-feedback');
const SHARE_W=1080, SHARE_H=1920, SHARE_MARGIN=0.08;
function canvasToBlob(canvas, type='image/jpeg', quality=0.9){ return new Promise((res)=>canvas.toBlob(res,type,quality)); }
async function composeShareCanvas(container,bg){
  const srcCanvas=await window.html2canvas(container,{backgroundColor:bg,scale:2,useCORS:true});
  const out=document.createElement('canvas'); const ctx=out.getContext('2d'); out.width=SHARE_W; out.height=SHARE_H; ctx.fillStyle=bg; ctx.fillRect(0,0,SHARE_W,SHARE_H);
  const targetW=SHARE_W*(1-SHARE_MARGIN*2), targetH=SHARE_H*(1-SHARE_MARGIN*2);
  const scale=Math.min(targetW/srcCanvas.width, targetH/srcCanvas.height);
  const drawW=Math.round(srcCanvas.width*scale), drawH=Math.round(srcCanvas.height*scale);
  const dx=Math.round((SHARE_W-drawW)/2), dy=Math.round((SHARE_H-drawH)/2); ctx.drawImage(srcCanvas,dx,dy,drawW,drawH);
  const year=new Date().getFullYear(); const line1='@bandita.elemental'; const line2=`© ${year} Marcy.Bing — Todos los derechos reservados`;
  const textSize=Math.round(Math.min(SHARE_W,SHARE_H)*0.028), lh=Math.round(textSize*1.25); const padX=24,padY=14,gap=6,r=14;
  const rounded=(x,y,w,h,rad,fill)=>{ctx.beginPath();ctx.moveTo(x+rad,y);ctx.arcTo(x+w,y,x+w,y+h,rad);ctx.arcTo(x+w,y+h,x,y+h,rad);ctx.arcTo(x,y+h,x,y,rad);ctx.arcTo(x,y,x+w,y,rad);ctx.closePath();ctx.fillStyle=fill;ctx.fill();};
  ctx.save(); ctx.font=`500 ${textSize}px Inter, system-ui, sans-serif`; ctx.fillStyle='#ffffff'; ctx.textBaseline='top'; const w1=ctx.measureText(line1).width, w2=ctx.measureText(line2).width; const bw=Math.max(w1,w2); const blockW=Math.round(bw+padX*2), blockH=Math.round(lh*2+gap+padY*2); const x=Math.round((SHARE_W-blockW)/2), y=SHARE_H-blockH-40; rounded(x,y,blockW,blockH,r,'rgba(0,0,0,0.35)'); ctx.fillText(line1,x+padX,y+padY); ctx.fillText(line2,x+padX,y+padY+lh+gap); ctx.restore(); return out;
}
if(shareBtn) shareBtn.addEventListener('click', async ()=>{
  try{
    if(!__lastStem) throw new Error('Calcula tu elemento primero');
    if(shareFeedback) shareFeedback.textContent='Generando tarjeta...';
    const container=$id('result-content-container'); const bg=elementPalette[__lastStem.element]||'#111827';
    const out=await composeShareCanvas(container,bg); const blob=await canvasToBlob(out,'image/jpeg',0.9);
    const filename=`bazi_story_${(__lastStem.element||'elemento').toLowerCase()}_${(__lastStem.polarity||'').toLowerCase()}.jpg`;
    const file=new File([blob], filename, {type:'image/jpeg'});
    const canNative=!!navigator.canShare && navigator.canShare({files:[file]}) && window.isSecureContext;
    if(canNative){ await navigator.share({files:[file],title:'Mi elemento BaZi',text:`Mi elemento ${__lastStem.element} ${__lastStem.polarity}`}); shareFeedback.textContent='Compartido ✅'; }
    else{ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); shareFeedback.textContent='Descargado ✅'; }
  }catch(err){ console.error(err); shareFeedback.textContent='No se pudo compartir: '+(err?.message||''); }
});

// =================== TESTS RÁPIDOS ===================
(function selfTests(){
  // Sanity parse
  console.assert(parseInputYMD('2025-10-14').y===2025, 'parseInputYMD falla');
  // Verifica calibración de HOY contra lo solicitado
  const {y,m,d}=CAL_OVERRIDE;
  const sDay=computeStemForYMD(y,m,d);
  const sMonth=computeMonthStemBranch(y,m,d);
  const sYear=computeYearStemBranch(y,m,d);
  console.log('[CHECK today]', {
    day:sDay.key,
    monthStem: STEM_TABLE[sMonth.stemIdx].key, monthBranch: BRANCHES[sMonth.branchIdx].key,
    yearStem: STEM_TABLE[sYear.stemIdx].key, yearBranch: BRANCHES[sYear.branchIdx].key
  });
  // Esperados: Bing (día), Bing/Xu (mes), Yi/Si (año)
  console.assert(sDay.key==='Bing', 'Día no es Bing (Fuego Yang)');
  console.assert(STEM_TABLE[sMonth.stemIdx].key==='Bing', 'Mes no es Bing (Fuego Yang)');
  console.assert(BRANCHES[sMonth.branchIdx].key==='Xu', 'Mes no es Xu (Perro)');
  console.assert(STEM_TABLE[sYear.stemIdx].key==='Yi', 'Año no es Yi (Madera Yin)');
  console.assert(BRANCHES[sYear.branchIdx].key==='Si', 'Año no es Si (Serpiente)');
  // Verificación de 10 dioses para DM Fuego Yang (Bing)
  console.assert(computeGodCode('Bing','Wu')===3, 'Fallo: Tierra Yang debería ser 3 (Output mismo polo)');
  console.assert(computeGodCode('Bing','Xin')===6, 'Fallo: Metal Yin debería ser 6 (Wealth opuesto)');
  console.assert(computeGodCode('Bing','Ding')===2, 'Fallo: Fuego Yin debería ser 2 (RR)');
  // Extra tests por tu ejemplo 1987-07-16 (Ding/Wei ocultos: Ding, Ji, Yi)
  console.assert(computeGodCode('Bing','Ding')===2, '1987-07-16: Ding debe ser 2');
  console.assert(computeGodCode('Bing','Ji')===4, '1987-07-16: Ji debe ser 4');
  console.assert(computeGodCode('Bing','Yi')===10, '1987-07-16: Yi debe ser 10');
})();
  </script>
</body>
</html>

